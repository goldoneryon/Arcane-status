<!-- L'extrait JavaScript seulement -->

<script>
  const tbody = document.querySelector("#servers-table tbody");
  const filterSelect = document.getElementById("filter");
  const ping = document.getElementById("ping");
  let previousStatus = {};
  let lastUpdateTime = Date.now();

  function getWeatherIcon(text) {
    text = text.toLowerCase();
    if (text.includes("sun")) return "☀️";
    if (text.includes("rain")) return "🌧️";
    if (text.includes("cloud")) return "☁️";
    if (text.includes("fog")) return "🌫️";
    return "❓";
  }

  function updateClock() {
    const seconds = Math.floor((Date.now() - lastUpdateTime) / 1000);
    document.getElementById("last-update").textContent = `Mise à jour il y a ${seconds}s`;
  }
  setInterval(updateClock, 1000);

  function renderTable(servers, filter) {
    tbody.innerHTML = "";
    servers.forEach(server => {
      if (filter !== "all" && server.status !== filter) return;

      const tr = document.createElement("tr");
      if (server.population.toLowerCase() === "low") tr.classList.add("recommended");

      const statusClass = {
        online: "status-online",
        full: "status-full",
        maintenance: "status-maintenance"
      };

      if (server.status === "Online" && previousStatus[server.name] !== "Online") {
        ping.play();
      }

      previousStatus[server.name] = server.status;

      tr.innerHTML = `
        <td>${server.name}</td>
        <td>${server.region}</td>
        <td class="${statusClass[server.status.toLowerCase()] || ''}">${server.status}</td>
        <td>${server.population}</td>
        <td>${getWeatherIcon(server.weather)} ${server.weather}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function fetchAndUpdate() {
    fetch("/.netlify/functions/getServers")
      .then(res => res.json())
      .then(data => {
        renderTable(data, filterSelect.value); // ✅ Correction ici
        lastUpdateTime = Date.now();
        updateClock();
      })
      .catch(err => {
        tbody.innerHTML = `<tr><td colspan="5">Erreur de chargement : ${err.message}</td></tr>`;
      });
  }

  filterSelect.addEventListener("change", fetchAndUpdate);

  fetchAndUpdate();
  setInterval(fetchAndUpdate, 30000); // toutes les 30 secondes
</script>
